<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 将 API 从 yii1 迁移到 yii2 · Rust.Love</title><meta name="description" content="将 API 从 yii1 迁移到 yii2 - OutMan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://rust.love/atom.xml" title="Rust.Love"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">将 API 从 yii1 迁移到 yii2</h1><div class="post-info">Dec 7, 2015</div><div class="post-content"><p>种种历史原因，导致无法使用使用严格的 RESTful 规则, 这里只是内部项目迁移过程中给大家普及的一点点小知识，因为是内部项目，对您可能并不通用。</p>
<h3 id="Yii2_basic_项目结构">Yii2 basic 项目结构</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── codeception<span class="class">.yml</span></span><br><span class="line">├── commands</span><br><span class="line">├── components</span><br><span class="line">├── composer<span class="class">.json</span></span><br><span class="line">├── composer<span class="class">.lock</span></span><br><span class="line">├── config</span><br><span class="line">├── controllers</span><br><span class="line">├── messages</span><br><span class="line">├── models</span><br><span class="line">├── runtime</span><br><span class="line">├── service</span><br><span class="line">├── tests</span><br><span class="line">├── vendor</span><br><span class="line">├── web</span><br><span class="line">├── yii</span><br><span class="line">└── yii.bat</span><br></pre></td></tr></table></figure>
<ul>
<li>API 规范</li>
<li>route</li>
<li>controllers</li>
<li>models</li>
<li>service</li>
<li>guzzlephp</li>
</ul>
<ol>
<li><p>API 简约规范<br>因为历史和现行的原因，不采用严格的 RESTful 定义的标准</p>
</li>
<li><p>route 映射规则</p>
</li>
</ol>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">'PUT <span class="xmlDocTag">&lt;controller&gt;</span>/<span class="xmlDocTag">&lt;id&gt;</span>'      =&gt; '<span class="xmlDocTag">&lt;controller&gt;</span>/update',</span></span><br><span class="line"><span class="comment">'DELETE <span class="xmlDocTag">&lt;controller&gt;</span>/<span class="xmlDocTag">&lt;id&gt;</span>'   =&gt; '<span class="xmlDocTag">&lt;controller&gt;</span>/delete',</span></span><br><span class="line"><span class="comment">'GET <span class="xmlDocTag">&lt;controller&gt;</span>/<span class="xmlDocTag">&lt;id&gt;</span>'      =&gt; '<span class="xmlDocTag">&lt;controller&gt;</span>/view',</span></span><br><span class="line"><span class="comment">'POST <span class="xmlDocTag">&lt;controller&gt;</span>'          =&gt; '<span class="xmlDocTag">&lt;controller&gt;</span>/create',</span></span><br><span class="line"><span class="comment">'GET <span class="xmlDocTag">&lt;controller&gt;</span>'           =&gt; '<span class="xmlDocTag">&lt;controller&gt;</span>/index',</span></span><br></pre></td></tr></table></figure>
<p>注: URL 驼峰式命名，需要用 - 分割，例如</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">'GET</span> pointAccount' =&gt; <span class="symbol">'point</span>-account/index',</span><br></pre></td></tr></table></figure>
<p>新代码尽量不要采用这种风格，应该尽量采用单个英文名词。</p>
<ol>
<li>controllers 统一继承自 <code>MainController</code> 需要注意的几个方法</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">beforeAction</span><br><span class="line">afterAction</span><br><span class="line"></span><br><span class="line">getRawBody  -&gt; <span class="function"><span class="title">file_get_contents</span><span class="params">(<span class="string">'php://input'</span>)</span></span></span><br><span class="line">json</span><br><span class="line">renderJson</span><br></pre></td></tr></table></figure>
<ol>
<li>models 在项目中使用 <code>Model</code> 和 <code>ActiveRecord</code> , 当前项目相关的父类是 <code>MainModel</code> 和 <code>MainActiveRecord</code></li>
</ol>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="command">\app</span><span class="command">\components</span><span class="command">\ModelTrait</span></span><br><span class="line">Model </span><br><span class="line">ActiveRecord</span><br></pre></td></tr></table></figure>
<ol>
<li>Service 是复杂业务和公共业务逻辑的抽象，保证 Controller 简单，不同入口的相同业务统一。</li>
<li><p>Guzzlephp 一套特别好用的 Http Client ，告别自己封装 curl。</p>
</li>
<li><p>入参验证，有对应 db 的采用 <code>MainActiveRecord</code> 为父类，无 db 对应的采用 <code>MainModel</code> 为父类，通过统一的 <code>Validator</code> 和自定义验证规则来做入参校验，避免写各种 <code>if else empty isset</code> 等判断逻辑。</p>
</li>
<li><p>返回值问题</p>
</li>
</ol>
<ul>
<li>结构统一 {“status”: integer(), “message”: string(), “data”: []}</li>
<li>大小写永远保持一致</li>
<li>类型明确</li>
</ul>
<h3 id="Codeception_安装">Codeception 安装</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer global require &#34;codeception/codeception=2.0.*&#34;&#10;$ composer global require &#34;codeception/specify=*&#34;&#10;$ composer global require &#34;codeception/verify=*&#34;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer global status&#10;Changed current directory to &#60;directory&#62;&#10;&#10;$ export PATH=&#34;$&#123;PATH&#125;:/&#60;directory&#62;/vendor/bin&#34;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ codecept -V&#10;Codeception version 2.0.16</span><br></pre></td></tr></table></figure>
<h3 id="Codeception_功能介绍">Codeception 功能介绍</h3><ul>
<li>Acceptance Testing 验收测试 (JS Ajax)</li>
<li>Functional Testing 功能测试 (No js)</li>
<li>API Testing </li>
<li>Unit Testing 单元测试</li>
</ul>
<ol>
<li>Acceptance Testing 验收测试 (JS Ajax)</li>
</ol>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$I</span> = new AcceptanceTester(<span class="variable">$scenario</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;amOnPage(<span class="string">'/'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;click(<span class="string">'Sign Up'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;submitForm(<span class="string">'#signup'</span>, <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'username'</span> =&gt; <span class="string">'MilesDavis'</span>, </span><br><span class="line">    <span class="string">'email'</span> =&gt; <span class="string">'miles@davis.com'</span></span><br><span class="line">));</span><br><span class="line"><span class="variable">$I-</span>&gt;see(<span class="string">'Thank you for Signing Up!'</span>);</span><br></pre></td></tr></table></figure>
<ol>
<li>Functional Testing 功能测试 (No js)</li>
</ol>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$I</span> = new FunctionalTester(<span class="variable">$scenario</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;amOnPage(<span class="string">'/'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;click(<span class="string">'Sign Up'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;submitForm(<span class="string">'#signup'</span>, <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'username'</span> =&gt; <span class="string">'MilesDavis'</span>, </span><br><span class="line">    <span class="string">'email'</span> =&gt; <span class="string">'miles@davis.com'</span>));</span><br><span class="line"><span class="variable">$I-</span>&gt;see(<span class="string">'Thank you for Signing Up!'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;seeEmailSent(<span class="string">'miles@davis.com'</span>, <span class="string">'Thank you for registration'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;seeInDatabase(<span class="string">'users'</span>, <span class="keyword">array</span>(<span class="string">'email'</span> =&gt; <span class="string">'miles@davis.com'</span>));</span><br></pre></td></tr></table></figure>
<ol>
<li>API Testing</li>
</ol>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$I</span> = new ApiTester(<span class="variable">$scenario</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;wantTo(<span class="string">'create a new user by API'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;amHttpAuthenticated(<span class="string">'davert'</span>,<span class="string">'123456'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;haveHttpHeader(<span class="string">'Content-Type'</span>,<span class="string">'application/x-www-form-urlencoded'</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;sendPOST(<span class="string">'/users'</span>, <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; <span class="string">'davert'</span> ));</span><br><span class="line"><span class="variable">$I-</span>&gt;seeResponseCodeIs(<span class="number">200</span>);</span><br><span class="line"><span class="variable">$I-</span>&gt;seeResponseIsJson();</span><br><span class="line"><span class="variable">$I-</span>&gt;seeResponseContainsJson(<span class="keyword">array</span>(<span class="string">'result'</span> =&gt; <span class="string">'ok'</span>));</span><br></pre></td></tr></table></figure>
<ol>
<li>Unit Testing 单元测试</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> \<span class="title">Codeception</span>\<span class="title">Util</span>\<span class="title">Stub</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> <span class="keyword">extends</span> \<span class="title">Codeception</span>\<span class="title">TestCase</span>\<span class="title">Test</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testUserSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = Stub::make(<span class="string">'User'</span>);</span><br><span class="line">        <span class="variable">$user</span>-&gt;setName(<span class="string">'davert'</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="string">'davert'</span>, <span class="variable">$user</span>-&gt;getName());</span><br><span class="line">        <span class="variable">$user</span>-&gt;save();</span><br><span class="line">        <span class="variable">$this</span>-&gt;tester-&gt;seeInDatabase(<span class="string">'users'</span>, <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; <span class="string">'davert'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2015/12/22/mysql-56-some-feature/" class="prev">上一篇</a><a href="/2015/12/04/php_codexception_api_testing/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://rust.love">OutMan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>